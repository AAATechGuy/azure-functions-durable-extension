<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Stateful Actor - Counter </title>
    <!-- Prevent search engine web crawlers from indexing or crawling this page -->
    <meta name="robots" content="none">
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Stateful Actor - Counter ">
    <meta name="generator" content="docfx 2.19.1.0">
    
    <link rel="shortcut icon" href="../../images/favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="stateful-actor---counter">Stateful Actor - Counter</h1>

<p>The <a href="https://en.wikipedia.org/wiki/Actor_model">Actor model</a> is an advanced stateful programming pattern that is becoming more common in distributed computing, particularly in the cloud. It is assumed that the reader is already familiar with the actor model and how actors are used, so we won&#39;t be going into those details here. The code in this sample demonstrates how Durable Functions can be used to implement the actor model. The specific example is a simple <em>counter</em> singleton object which supports <em>increment</em> and <em>decrement</em> operations.</p>
<h2 id="before-you-begin">Before you begin</h2>
<p>If you haven&#39;t done so already, make sure to read the <a href="../overview.html">overview</a> before jumping into samples. It will really help ensure everything you read below makes sense.</p>
<p>All samples are combined into a single function app package. To get started with the samples, do the following:</p>
<ol>
<li>Create a new function app at <a href="https://functions.azure.com/signin">https://functions.azure.com/signin</a>.</li>
<li>Follow the <a href="../installation.html">installation instructions</a> to configure Durable Functions.</li>
<li>Download the <a href="../../files/DFSampleApp.zip">DFSampleApp.zip</a> package.</li>
<li>Unzip the sample package file into <code>D:\home\site\wwwroot</code> using Kudu or FTP.</li>
</ol>
<p>This article will specifically walk through the following function in the sample app:</p>
<ul>
<li><strong>E3_Counter</strong></li>
</ul>
<div class="NOTE"><h5>Note</h5><p>This walkthrough assumes you have already gone through the <a href="sequence.html">Hello Sequence</a> sample walkthrough. If you haven&#39;t done so already, it is recommended to first go through that walkthrough before starting this one.</p>
</div>
<h2 id="scenario-overview">Scenario overview</h2>
<p>The counter scenario is very simple to understand, but surprisingly difficult to implement using regular stateless functions. The main challenge you have is managing <strong>concurrency</strong>. Operations like <em>increment</em> and <em>decrement</em> need to be atomic, or else there could be race conditions that cause operations to overwrite each other.</p>
<p>Using a single VM to host the counter data is one option, but this is expensive and managing <strong>reliability</strong> can be a challenge since a single VM will need to be periodically rebooted. You could alternatively use a distributed platform with synchronization tools like blob leases to help manage concurrency, but this introduces a great deal of <strong>complexity</strong>.</p>
<p>Durable Functions makes this kind of scenario trivial to implement because orchestration instances affinitized to a single VM and orchestrator function execution is always single-threaded. Not only that, but they are long-running, stateful, and can react to external events, making them look and behave just like a reliable actor. The sample code below will demonstrate how to implement such a counter as a long-running orchestrator function.</p>
<h2 id="the-counter-orchestration">The counter orchestration</h2>
<p>The <strong>E3_Counter</strong> function uses the standard function.json for orchestrator functions.</p>
<pre><code class="lang-json" name="Main">{
  &quot;bindings&quot;: [
    {
      &quot;name&quot;: &quot;counterContext&quot;,
      &quot;type&quot;: &quot;orchestrationTrigger&quot;,
      &quot;direction&quot;: &quot;in&quot;
    }
  ],
  &quot;disabled&quot;: false
}
</code></pre><p>Here is the code which implements the function:</p>
<pre><code class="lang-csharp" name="Main">#r &quot;Microsoft.Azure.WebJobs.Extensions.DurableTask&quot;

public static async Task&lt;int&gt; Run(
    DurableOrchestrationContext counterContext,
    TraceWriter log)
{
    int counterState = counterContext.GetInput&lt;int&gt;();
    log.Info($&quot;Current counter state is {counterState}. Waiting for next operation.&quot;);

    string operation = await counterContext.WaitForExternalEvent&lt;string&gt;(&quot;operation&quot;);
    log.Info($&quot;Received &#39;{operation}&#39; operation.&quot;);

    operation = operation?.ToLowerInvariant();
    if (operation == &quot;incr&quot;)
    {
        counterState++;
    }
    else if (operation == &quot;decr&quot;)
    {
        counterState--;
    }
    
    if (operation != &quot;end&quot;)
    {
        counterContext.ContinueAsNew(counterState);
    }

    return counterState;
}
</code></pre><p>This orchestrator function essentially does the following:</p>
<ol>
<li>Listens for an external event named <em>operation</em> using <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationContext.html#Microsoft_Azure_WebJobs_DurableOrchestrationContext_WaitForExternalEvent_">WaitForExternalEvent</a>&gt;.</li>
<li>Increments or decrements the <code>counterState</code> local variable depending on the operation requested.</li>
<li>Restarts the orchestrator using the <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationContext.html#Microsoft_Azure_WebJobs_DurableOrchestrationContext_ContinueAsNew_">ContinueAsNew</a> method, setting the latest value of <code>counterState</code> as the new input.</li>
<li>Continues running forever or until an <em>end</em> message is received.</li>
</ol>
<p>This is an example of an <em>eternal orchestration</em> - i.e. one that potentially never ends. It responds to messages sent to it using the <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationClient.html#Microsoft_Azure_WebJobs_DurableOrchestrationClient_RaiseEventAsync_">RaiseEventAsync</a> method, which can be called by any non-orchestrator function.</p>
<p>One unique characteristic of this orchestrator function is that it effectively has no history: the <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationContext.html#Microsoft_Azure_WebJobs_DurableOrchestrationContext_ContinueAsNew_">ContinueAsNew</a> method will reset the history after each processed event. This is the prefered way to implement an orchestrator which has an arbitrary lifetime as using a <code>while</code> loop could cause the orchestrator function&#39;s history to grow unbounded, resulting in unnecessarily high memory usage.</p>
<div class="NOTE"><h5>Note</h5><p>The <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationContext.html#Microsoft_Azure_WebJobs_DurableOrchestrationContext_ContinueAsNew_">ContinueAsNew</a> method has other interesting use-cases besides just eternal orchestrations. See the <a href="../topics/eternal-orchestrations.html">Eternal Orchestrations</a> topic guide for more information.</p>
</div>
<h2 id="running-the-sample">Running the sample</h2>
<p>Using the HTTP-triggered functions included in the sample, you can start the orchestration using the below HTTP POST request. We don&#39;t include any content in this request, which allows <code>counterState</code> to start at zero (the default value for <code>int</code>).</p>
<pre><code class="lang-plaintext">POST http://{app-name}.azurewebsites.net/orchestrators/E3_Counter HTTP/1.1
Content-Length: 0
</code></pre><pre><code class="lang-plaintext">HTTP/1.1 202 Accepted
Content-Length: 260
Content-Type: application/json; charset=utf-8
Location: http://{app-name}.azurewebsites.net/orchestrations/a6cc0f94907f40d6ba09b2b14460a51d

{&quot;id&quot;:&quot;a6cc0f94907f40d6ba09b2b14460a51d&quot;,&quot;pollUrl&quot;:&quot;http://{app-name}.azurewebsites.net/orchestrations/a6cc0f94907f40d6ba09b2b14460a51d&quot;,&quot;sendEventUrl&quot;:&quot;http://{app-name}.azurewebsites.net/orchestrations/a6cc0f94907f40d6ba09b2b14460a51d/SendEvent/{eventName}&quot;}
</code></pre><p>The <strong>E3_Counter</strong> instance starts and then immediately waits for an event to be sent to it using <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationClient.html#Microsoft_Azure_WebJobs_DurableOrchestrationClient_RaiseEventAsync_">RaiseEventAsync</a> or using the <strong>sendEventUrl</strong> HTTP POST webhook referenced in the 202 response above. Valid <code>eventName</code> values include <em>incr</em>, <em>decr</em>, and <em>end</em>.</p>
<div class="NOTE"><h5>Note</h5><p>Feel free to take a look at the source code for HttpSendEvent to get an idea of how <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationClient.html#Microsoft_Azure_WebJobs_DurableOrchestrationClient_RaiseEventAsync_">RaiseEventAsync</a> is used by client functions.</p>
</div>
<pre><code class="lang-plaintext">POST http://{app-name}.azurewebsites.net/orchestrations/a6cc0f94907f40d6ba09b2b14460a51d/SendEvent/operation HTTP/1.1
Content-Type: application/json
Content-Length: 6

&quot;incr&quot;
</code></pre><p>You can see the results of the &quot;incr&quot; operation by looking at the function logs in the Azure Functions portal.</p>
<pre><code class="lang-plaintext">2017-05-08T17:33:23.438 Function started (Id=43d0b498-22d6-4cd8-a1c1-afdda6b9964a)
2017-05-08T17:33:23.438 Current counter state is 0. Waiting for next operation.
2017-05-08T17:36:51.555 Function started (Id=3c093c86-e6fe-4370-9d62-e4e33f44f53d)
2017-05-08T17:36:51.555 Current counter state is 0. Waiting for next operation.
2017-05-08T17:36:51.586 Received &#39;incr&#39; operation.
2017-05-08T17:36:51.685 Function completed (Success, Id=3c093c86-e6fe-4370-9d62-e4e33f44f53d, Duration=138ms)
2017-05-08T17:36:51.856 Function started (Id=f7a58ad9-ff20-41eb-a3d9-4ed89788545d)
2017-05-08T17:36:51.856 Current counter state is 1. Waiting for next operation.
</code></pre><p>Similarly, if you check the orchestrator status, you should see the <code>input</code> field has been set to the updated value (1).</p>
<pre><code class="lang-plaintext">GET http://{app-name}.azurewebsites.net/orchestrations/a6cc0f94907f40d6ba09b2b14460a51d HTTP/1.1
</code></pre><pre><code class="lang-plaintext">HTTP/1.1 202 Accepted
Content-Length: 129
Content-Type: application/json; charset=utf-8
Location: http://{app-name}.azurewebsites.net/orchestrations/a6cc0f94907f40d6ba09b2b14460a51d

{&quot;runtimeStatus&quot;:&quot;Running&quot;,&quot;input&quot;:1,&quot;output&quot;:null,&quot;createdTime&quot;:&quot;2017-05-08T17:36:51Z&quot;,&quot;lastUpdatedTime&quot;:&quot;2017-05-08T17:37:01Z&quot;}
</code></pre><p>You can continue sending new operations to this instance and observe its state gets updated accordingly. If you wish to kill the instance, you can do so by sending an <em>end</em> operation.</p>
<div class="WARNING"><h5>Warning</h5><p>There are currently race conditions in both the handling of <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationClient.html#Microsoft_Azure_WebJobs_DurableOrchestrationClient_RaiseEventAsync_">RaiseEventAsync</a> and the use of <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationContext.html#Microsoft_Azure_WebJobs_DurableOrchestrationContext_ContinueAsNew_">ContinueAsNew</a>. Until these are addressed, it is highly recommended to not send more than one external event to an instance every few seconds.</p>
</div>
<h2 id="wrapping-up">Wrapping up</h2>
<p>At this point, you should have a better understanding of some of the advanced capabilities of Durable Functions, notably <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationContext.html#Microsoft_Azure_WebJobs_DurableOrchestrationContext_WaitForExternalEvent_">WaitForExternalEvent</a> and <a class="xref" href="../../api/Microsoft.Azure.WebJobs.DurableOrchestrationContext.html#Microsoft_Azure_WebJobs_DurableOrchestrationContext_ContinueAsNew_">ContinueAsNew</a>. These tools should enable you to write &quot;eternal orchestrations&quot; and/or implement the stateful actor pattern.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/Azure/azure-functions-durable-extension/blob/master/docfx/articles/samples/counter.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            Copyright © Microsoft Corporation
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
